---
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: alertmanager
spec:
  route:
    receiver: telegram
    groupBy:
      - alertname
      - job
    groupWait: 1m
    groupInterval: 5m
    repeatInterval: 12h
    routes:
      - receiver: blackhole
        matchers:
          - name: alertname
            matchType: "="
            value: Watchdog
      - receiver: blackhole
        matchers:
          - name: alertname
            matchType: "="
            value: InfoInhibitor

  inhibitRules:
    - equal:
        - alertname
        - namespace
      sourceMatch:
        - name: severity
          matchType: "="
          value: critical
      targetMatch:
        - name: severity
          matchType: "="
          value: warning

  receivers:
    - name: blackhole

    - name: telegram
      telegramConfigs:
        - sendResolved: true
          chatID: -1003021821850
          messageThreadID: 2
          parseMode: HTML
          botToken:
            name: alertmanager-secret
            key: BOT_TOKEN

          message: |-
            {{- $severity := .CommonLabels.severity -}}
            {{- $status := .Status -}}
            {{- $severityIcon := "âšªï¸" -}}
            {{- if eq $severity "critical" }}{{ $severityIcon = "ğŸ”´" }}{{ else if eq $severity "warning" }}{{ $severityIcon = "ğŸŸ " }}{{ end -}}

            {{- if eq $status "firing" -}}
            {{ $severityIcon }} <b>[FIRING:{{ .Alerts.Firing | len }}] {{ .CommonLabels.alertname }}</b>
            {{- else -}}
            âœ… <b>[RESOLVED] {{ .CommonLabels.alertname }}</b>
            {{- end }}

            <b>Severity:</b> {{ $severityIcon }} {{ $severity | title }}
            {{- range .Alerts }}

            â€”â€”â€”
            {{- if ne .Annotations.description "" }}
            ğŸ“ {{ .Annotations.description }}
            {{- else if ne .Annotations.summary "" }}
            ğŸ“ {{ .Annotations.summary }}
            {{- else if ne .Annotations.message "" }}
            ğŸ“ {{ .Annotations.message }}
            {{- else }}
            ğŸ“ <i>Alert description not available</i>
            {{- end }}

            <b>Labels:</b>
            {{- range .Labels.SortedPairs }}
            â€¢ <code>{{ .Name }}</code>: {{ .Value }}
            {{- end }}
            {{- if .Annotations.runbook_url }}

            <a href="{{ .Annotations.runbook_url }}">ğŸ“– Runbook</a>
            {{- end }}
            {{- end }}
